<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EmailJS CSV Rotator (Refresh-Proof)</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input[type="file"] { margin-bottom: 10px; }
    #status { margin-top: 15px; font-weight: bold; }
    button { padding: 8px 12px; margin: 5px; }
  </style>
</head>
<body>
  <h2>EmailJS Auto Sender (Refresh-Proof)</h2>
  <input type="file" id="csvFile" accept=".csv" />
  <button id="pauseBtn">‚è∏ Pause</button>
  <button id="resumeBtn">‚ñ∂ Resume</button>
  <p id="status">Upload your CSV to begin...</p>

  <script>
    const emailAccounts = [
      {
        serviceID: 'service_dpddfu8',
        templateID: 'template_mtxhelt',
        publicKey: 'Hjhu0lQHnIhWwnc5f'
      },
      {
        serviceID: 'service_18a2czr',
        templateID: 'template_l4ni91d',
        publicKey: 'MaT8uSC8px4Mo8iik'
      },
      {
        serviceID: 'service_rd3mgro',
        templateID: 'template_95tpex7',
        publicKey: 'kH6MFB65FZRI8OQsN'
      },
      {
        serviceID: 'service_urbrati',
        templateID: 'template_32ta9rb',
        publicKey: '29JWVNzQ5OHNYKilW'
      },
      {
        serviceID: 'service_312uxnp',
        templateID: 'template_fewzmko',
        publicKey: 'CHvErJNKqgQGXF1OK'
      },
      {
        serviceID: 'service_0phbhha',
        templateID: 'template_tfh8zg2',
        publicKey: 'oPJ7Dc3pZzCRXsxpZ'
      },
      {
        serviceID: 'service_mrxk2c8',
        templateID: 'template_vtpm26s',
        publicKey: 'TohM3Q_EABo2n1kwX'
      }
    ];

    let dataRows = [];
    let rowIndex = 0;
    let accountIndex = 0;
    let isPaused = false;
    let emailInterval;

    function loadProgress() {
      if (localStorage.getItem('emailSenderData')) {
        const saved = JSON.parse(localStorage.getItem('emailSenderData'));
        rowIndex = saved.rowIndex || 0;
        accountIndex = saved.accountIndex || 0;
        if (saved.csvData) {
          dataRows = saved.csvData;
          document.getElementById('status').innerText =
            `üîµ Ready to resume from row ${rowIndex + 1}/${dataRows.length}`;
        }
      }
    }
    loadProgress();

    function saveProgress() {
      localStorage.setItem('emailSenderData', JSON.stringify({
        rowIndex,
        accountIndex,
        csvData: dataRows
      }));
    }

    function sendNextEmail() {
      if (isPaused || dataRows.length === 0) return;

      const currentAccount = emailAccounts[accountIndex];
      const currentData = dataRows[rowIndex];

      emailjs.init(currentAccount.publicKey);

      const templateParams = {
        Name: currentData.Name,
        vin: currentData.VIN,
        Address: currentData.Address,
        email: currentData.Email
      };

      emailjs.send(currentAccount.serviceID, currentAccount.templateID, templateParams)
        .then(res => {
          document.getElementById('status').innerText =
            `‚úÖ Sent to: ${templateParams.email} (Row ${rowIndex + 1}/${dataRows.length}) | Next in 10 minutes`;

          rowIndex = (rowIndex + 1) % dataRows.length;
          accountIndex = (accountIndex + 1) % emailAccounts.length;
          saveProgress();
        })
        .catch(err => {
          document.getElementById('status').innerText =
            `‚ùå Error sending to: ${templateParams.email} (Retrying next cycle)`;
        });
    }

    document.getElementById('csvFile').addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          dataRows = results.data;
          saveProgress();
          document.getElementById('status').innerText =
            `‚úÖ Loaded ${dataRows.length} records. Starting in 5 seconds...`;

          setTimeout(() => {
            if (emailInterval) clearInterval(emailInterval);
            emailInterval = setInterval(sendNextEmail, 10 * 60 * 1000);
            sendNextEmail();
          }, 5000);
        }
      });
    });

    document.getElementById('pauseBtn').addEventListener('click', () => {
      isPaused = true;
      document.getElementById('status').innerText += ' (PAUSED)';
    });

    document.getElementById('resumeBtn').addEventListener('click', () => {
      isPaused = false;
      document.getElementById('status').innerText = '‚ñ∂ RESUMED - Next email will send soon...';
      sendNextEmail();
    });
  </script>
</body>
</html>
